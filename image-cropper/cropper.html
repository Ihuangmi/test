<!-- å®Œæ•´è£å‰ªå›¾ç‰‡çš„åŠŸèƒ½ -->
<!DOCTYPE html>
<html>
  <head>
    <title>å›¾ç‰‡è£å‰ªå™¨2</title>
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <input id="file" type="file" />
    <div id="container" class="container">
      <img id="bgImage" width="100%" height="100%" />
      <div id="mask" class="mask">
        <div id="maskView" class="mask__view"></div>
      </div>
      <div id="cropper" class="cropper">
        <div id="cropperView" class="cropper__view">
          <span class="cropper-dashed dashed-h"></span>
          <span class="cropper-dashed dashed-v"></span>
          <span class="cropper-center"></span>
          <span class="cropper-move"></span>
          <!-- å››æ¡è¾¹æ¡†çº¿ -->
          <span class="cropper-line line-n" data-action="top"></span>
          <span class="cropper-line line-e" data-action="right"></span>
          <span class="cropper-line line-s" data-action="bottom"></span>
          <span class="cropper-line line-w" data-action="left"></span>
          <!-- å…«ä¸ªç‚¹ -->
          <span class="cropper-point point-e"></span>
          <span class="cropper-point point-n"></span>
          <span class="cropper-point point-w"></span>
          <span class="cropper-point point-s"></span>
          <span class="cropper-point point-nw" data-action="top-left"></span>
          <span class="cropper-point point-ne" data-action="top-right"></span>
          <span
            class="cropper-point point-se"
            data-action="bottom-right"
          ></span>
          <span class="cropper-point point-sw" data-action="bottom-left"></span>
        </div>
      </div>
    </div>
    <button id="btn">è£å‰ª</button>
    <canvas id="canvasCropping"></canvas>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const file = document.getElementById("file");
        const bgImage = document.getElementById("bgImage");
        const mask = document.getElementById("mask");
        const maskView = document.getElementById("maskView");
        const cropper = document.getElementById("cropper");
        const cropperView = document.getElementById("cropperView");

        // å°†å›¾ç‰‡è®¾ç½®åˆ°è£å‰ªæ¡†
        file.addEventListener("change", (e) => {
          const target = e.target.files[0];
          const imgURL = URL.createObjectURL(target);
          bgImage.src = imgURL;
          maskView.style.backgroundImage = `url('${imgURL}')`;
          bgImage.onload = () => {
            createCropper();
          };
        });

        // åˆå§‹è£å‰ªæ¡†è·ç¦»å››è¾¹çš„è·ç¦»
        let initDimention = [50, 50, 50, 50];
        const TOP = 0,
          RIGHT = 1,
          BOTTOM = 2,
          LEFT = 3;
        // æ˜¯å¦åœ¨æ‹–åŠ¨ä¸­
        let dragging = false;
        // è®°å½•é¼ æ ‡æŒ‰ä¸‹çš„ä½ç½®
        let startPoint = [0, 0];
        // å½“å‰è£å‰ªå™¨çš„å®æ—¶å°ºå¯¸
        let currentDimention = [];
        // è®°å½•è£å‰ªå™¨å¼€å§‹çš„å°ºå¯¸
        let startDimention = [];
        // è®°å½•è£å‰ªå™¨å®æ—¶å°ºå¯¸
        let currentElement = null;
        // è®°å½•å“ªä¸ªæ–¹å‘çš„è¾¹æ¡†è¿›è¡Œäº†æ‹–åŠ¨ï¼Œtop=1; right=-1; bottom=-1; left=1;  å‡è®¾å½“ direction = [1, -1, 0, 0] çš„æ—¶ï¼Œæ˜¯å³ä¸Šè§’çš„ç«¯ç‚¹è¿›è¡Œäº†æ‹–åŠ¨
        let direction = [0, 0, 0, 0];
        // æ˜¯å¦æ‹–åŠ¨è£å‰ªå™¨
        let moving = false;

        // ç”Ÿæˆè£å‰ªå™¨
        function createCropper() {
          mask.style.display = "block";
          cropper.style.display = "block";
          setDimention(initDimention);
          const moveElement = document.querySelector(".cropper-move");

          // è¾¹æ¡†å››å‘¨ï¼šå››æ¡è¾¹æ¡†çº¿ã€å…«ä¸ªç‚¹
          const elements = [
            moveElement,
            ...document.querySelectorAll(".cropper-line"), // å››æ¡è¾¹æ¡†çº¿
            ...document.querySelectorAll(".cropper-point"), // å…«ä¸ªç‚¹
          ];
          elements.forEach((ele) => {
            // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶  ä¸»è¦æ˜¯æ ‡è®°æ˜¯å¦å¼€å§‹æ‹–åŠ¨ä¸­ã€é¼ æ ‡ä½ç½®ã€è£å‰ªå™¨å°ºå¯¸ç­‰
            ele.addEventListener("mousedown", (e) => {
              console.log("ğŸš€ ~ ele.addEventListener ~ e:", e);
              dragging = true;
              // è®°å½•é¼ æ ‡åˆå§‹ä½ç½®
              const { clientX, clientY } = e;
              startPoint[0] = clientX;
              startPoint[1] = clientY;
              currentElement = ele;
              currentDimention = initDimention;
              startDimention = [...initDimention];

              // æ‹–åŠ¨è£å‰ªå™¨ï¼Œå››æ¡è¾¹æ¡†éƒ½ç§»åŠ¨äº†
              if (ele === moveElement) {
                direction[TOP] = 1;
                direction[BOTTOM] = -1;
                direction[LEFT] = 1;
                direction[RIGHT] = -1;
                moving = true;
              }

              const action = ele.dataset.action;
              // è®°å½•å“ªä¸ªæ–¹å‘çš„è¾¹æ¡†è¿›è¡Œäº†æ‹–åŠ¨ï¼Œtop=1; right=-1; bottom=-1; left=1;
              switch (action) {
                case "top":
                  // é¡¶éƒ¨è¾¹æ¡†æ‹–åŠ¨
                  direction[TOP] = 1;
                  direction[BOTTOM] = 0;
                  break;
                case "right":
                  direction[LEFT] = 0;
                  direction[RIGHT] = -1;
                  break;
                case "bottom":
                  direction[TOP] = 0;
                  direction[BOTTOM] = -1;
                  break;
                case "left":
                  direction[LEFT] = 1;
                  direction[RIGHT] = 0;
                  break;
                case "top-right":
                  // å³ä¸Šè¾¹æ¡†æ‹–åŠ¨
                  direction[TOP] = 1;
                  direction[RIGHT] = -1;
                  break;
                case "top-left":
                  direction[TOP] = 1;
                  direction[LEFT] = 1;
                  break;
                case "bottom-left":
                  direction[BOTTOM] = -1;
                  direction[LEFT] = 1;
                  break;
                case "bottom-right":
                  direction[BOTTOM] = -1;
                  direction[RIGHT] = -1;
                  break;
              }
            });
          });
        }

        // é¼ æ ‡ç§»åŠ¨äº‹ä»¶  ç›‘å¬é¼ æ ‡æ‹–åŠ¨çš„è·ç¦»ï¼Œè®¡ç®—è£å‰ªæ¡†çš„å¤§å°
        document.body.addEventListener("mousemove", (e) => {
          if (!dragging) return;
          const { clientX, clientY } = e;
          // è®¡ç®—é¼ æ ‡æ‹–åŠ¨çš„è·ç¦»
          let diffX = clientX - startPoint[0]; // é¼ æ ‡æ¨ªå‘æ‹–åŠ¨è·ç¦»ï¼ˆå‘å·¦ä¸ºè´Ÿå€¼ï¼Œå‘å³ä¸ºæ­£ï¼‰
          let diffY = clientY - startPoint[1]; // é¼ æ ‡çºµå‘æ‹–åŠ¨è·ç¦»ï¼ˆå‘ä¸Šä¸ºè´Ÿå€¼ï¼Œå‘ä¸‹ä¸ºæ­£ï¼‰

          // å¤„ç†ç§»åŠ¨çš„è¾¹æ¡†æƒ…å†µ
          if (moving) {
            diffX = Math.min(
              Math.max(diffX, -startDimention[LEFT]),
              startDimention[RIGHT]
            );
            diffY = Math.min(
              Math.max(diffY, -startDimention[TOP]),
              startDimention[BOTTOM]
            );
          }

          // è£å‰ªæ¡†æœ€å°å®½åº¦ä¸é«˜åº¦
          const minWidth = 30;
          const minHeight = 30;
          currentDimention[TOP] = Math.min(
            Math.max(startDimention[TOP] + direction[TOP] * diffY, 0),
            cropper.clientHeight - currentDimention[BOTTOM] - minHeight
          );
          currentDimention[RIGHT] = Math.min(
            Math.max(startDimention[RIGHT] + direction[RIGHT] * diffX, 0),
            cropper.clientWidth - currentDimention[LEFT] - minWidth
          );
          currentDimention[BOTTOM] = Math.min(
            Math.max(startDimention[BOTTOM] + direction[BOTTOM] * diffY, 0),
            cropper.clientHeight - currentDimention[TOP] - minHeight
          );
          currentDimention[LEFT] = Math.min(
            Math.max(startDimention[LEFT] + direction[LEFT] * diffX, 0),
            cropper.clientWidth - currentDimention[RIGHT] - minWidth
          );
          setDimention(currentDimention);
        });

        // é¼ æ ‡æŒ‰é”®æŠ¬èµ·äº‹ä»¶
        document.body.addEventListener("mouseup", () => {
          dragging = false;
          moving = false;
          direction[TOP] = 0;
          direction[BOTTOM] = 0;
          direction[LEFT] = 0;
          direction[RIGHT] = 0;
        });

        // æ§åˆ¶è£å‰ªå™¨çš„å¤§å°ä¸ç§»åŠ¨   dimention å‚æ•°çš„å€¼ï¼Œä¸ä¸Šä¸€æ¬¡ç›¸æ¯”ï¼Œæœ‰ä¸€é¡¹æˆ–è€…ä¸¤é¡¹å€¼å˜åŒ–æ—¶ï¼Œå³æ˜¯è£å‰ªå™¨çš„å¤§å°å˜åŒ–äº†ï¼›å¦‚æœå››é¡¹å€¼éƒ½å˜åŒ–äº†ï¼Œåˆ™æ˜¯è£å‰ªå™¨ç§»åŠ¨äº†ã€‚
        function setDimention(dimention) {
          cropperView.style.inset = `${dimention[TOP]}px ${dimention[RIGHT]}px ${dimention[BOTTOM]}px ${dimention[LEFT]}px`;
          maskView.style.clipPath = `inset(${dimention[TOP]}px ${dimention[RIGHT]}px ${dimention[BOTTOM]}px ${dimention[LEFT]}px)`;
        }

        // ç‚¹å‡»è£å‰ª
        const btn = document.getElementById("btn");
        btn.addEventListener("click", () => {
          // currentDimention: top/right/bottom/left
          if (currentDimention.length > 0) {
            // å›¾ç‰‡çš„å®½åº¦ä¸é«˜åº¦  getBoundingClientRect æä¾›äº†å…ƒç´ çš„å¤§å°åŠå…¶ç›¸å¯¹äºè§†å£çš„ä½ç½®ã€‚
            const { width: imageWidth, height: imageHeight } =
              bgImage.getBoundingClientRect();

            // åˆ›å»ºä¸€ä¸ªcanvasç”¨äºè£å‰ªæ“ä½œï¼Œå…¶å®ä¹Ÿå¯ä»¥å°†bgImageæœ¬èº«å˜æˆä¸€ä¸ªcanvasï¼Œç›´æ¥åœ¨ä¸Šé¢æ“ä½œå°±è¡Œ
            const canvas = document.createElement("canvas");
            const canvasCtx = canvas.getContext("2d");
            canvas.width = imageWidth;
            canvas.height = imageHeight;
            // ç»˜åˆ¶ç…§ç‰‡
            canvasCtx.drawImage(bgImage, 0, 0, imageWidth, imageHeight);
            // è£å‰ªç…§ç‰‡
            const x = currentDimention[LEFT];
            const y = currentDimention[TOP];
            const width =
              imageWidth - currentDimention[LEFT] - currentDimention[RIGHT];
            const height =
              imageHeight - currentDimention[TOP] - currentDimention[BOTTOM];
            const croppingImageData = canvasCtx.getImageData(
              x,
              y,
              width,
              height
            );

            // é€šè¿‡canvaså±•ç¤ºè£å‰ªçš„ç…§ç‰‡
            const canvasCropping = document.getElementById("canvasCropping");
            const canvasCroppingCtx = canvasCropping.getContext("2d");

            canvasCropping.width = croppingImageData.width;
            canvasCropping.height = croppingImageData.height;
            // æ¸…ç©ºä¸€ä¸‹ç”»å¸ƒ
            canvasCroppingCtx.clearRect(
              0,
              0,
              croppingImageData.width,
              croppingImageData.height
            );
            //å°†è£å‰ªåˆ°çš„ç…§ç‰‡ç»˜åˆ¶åˆ°æ–°çš„ç”»å¸ƒä¸­é¢„è§ˆ
            canvasCroppingCtx.putImageData(croppingImageData, 0, 0);
          }
        });
      });
    </script>
  </body>
</html>
